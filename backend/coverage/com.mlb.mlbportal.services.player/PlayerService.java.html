<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="es"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>PlayerService.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">MLBPortal</a> &gt; <a href="index.source.html" class="el_package">com.mlb.mlbportal.services.player</a> &gt; <span class="el_source">PlayerService.java</span></div><h1>PlayerService.java</h1><pre class="source lang-java linenums">package com.mlb.mlbportal.services.player;

import java.io.IOException;
import java.util.ArrayList;
import java.util.List;
import java.util.Optional;
import java.util.function.Function;

import org.springframework.data.domain.Page;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;
import org.springframework.web.multipart.MultipartFile;

import com.mlb.mlbportal.dto.player.PlayerDTO;
import com.mlb.mlbportal.dto.player.pitcher.CreatePitcherRequest;
import com.mlb.mlbportal.dto.player.pitcher.EditPitcherRequest;
import com.mlb.mlbportal.dto.player.pitcher.PitcherDTO;
import com.mlb.mlbportal.dto.player.pitcher.PitcherSummaryDTO;
import com.mlb.mlbportal.dto.player.position.CreatePositionPlayerRequest;
import com.mlb.mlbportal.dto.player.position.EditPositionPlayerRequest;
import com.mlb.mlbportal.dto.player.position.PositionPlayerDTO;
import com.mlb.mlbportal.dto.player.position.PositionPlayerSummaryDTO;
import com.mlb.mlbportal.handler.conflict.PlayerAlreadyExistsException;
import com.mlb.mlbportal.handler.conflict.RosterFullException;
import com.mlb.mlbportal.handler.notFound.TeamNotFoundException;
import com.mlb.mlbportal.mappers.player.PitcherMapper;
import com.mlb.mlbportal.mappers.player.PositionPlayerMapper;
import com.mlb.mlbportal.models.Team;
import com.mlb.mlbportal.models.others.PictureInfo;
import com.mlb.mlbportal.models.player.Pitcher;
import com.mlb.mlbportal.models.player.Player;
import com.mlb.mlbportal.models.player.PositionPlayer;
import com.mlb.mlbportal.repositories.TeamRepository;
import com.mlb.mlbportal.repositories.player.PitcherRepository;
import com.mlb.mlbportal.repositories.player.PlayerRepository;
import com.mlb.mlbportal.repositories.player.PositionPlayerRepository;
import com.mlb.mlbportal.services.uploader.PictureService;
import com.mlb.mlbportal.services.utilities.PaginationHandlerService;

import lombok.AllArgsConstructor;

@Service
@AllArgsConstructor
public class PlayerService {
    private final PlayerRepository playerRepository;
    private final PositionPlayerRepository positionPlayerRepository;
    private final PitcherRepository pitcherRepository;

    private final PositionPlayerMapper positionPlayerMapper;
    private final PitcherMapper pitcherMapper;

    private final TeamRepository teamRepository;

    private final PictureService pictureService;

    private final PaginationHandlerService paginationHandlerService;

    @Transactional
    public Page&lt;PlayerDTO&gt; getAllPlayers(int page, int size) {
<span class="fc" id="L60">        List&lt;PositionPlayer&gt; positionPlayers = this.positionPlayerRepository.findAll();</span>
<span class="fc" id="L61">        List&lt;Pitcher&gt; pitcherList = this.pitcherRepository.findAll();</span>

<span class="fc" id="L63">        this.updateAndSaveStats(positionPlayers);</span>
<span class="fc" id="L64">        this.updateAndSaveStats(pitcherList);</span>

<span class="fc" id="L66">        List&lt;PositionPlayerDTO&gt; mappedPositionPlayers = this.positionPlayerMapper</span>
<span class="fc" id="L67">                .toListPositionPlayerDTO(positionPlayers);</span>
<span class="fc" id="L68">        List&lt;PitcherDTO&gt; mappedPitchers = this.pitcherMapper.toListPitcherDTO(pitcherList);</span>

<span class="fc" id="L70">        List&lt;PlayerDTO&gt; result = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L71">        result.addAll(mappedPositionPlayers);</span>
<span class="fc" id="L72">        result.addAll(mappedPitchers);</span>

<span class="fc" id="L74">        result.sort((p1, p2) -&gt; p1.name().compareToIgnoreCase(p2.name()));</span>
<span class="fc" id="L75">        return this.paginationHandlerService.paginateAndMap(result, page, size, Function.identity());</span>
    }

    @Transactional
    public Page&lt;PositionPlayerDTO&gt; getAllPositionPlayers(int page, int size) {
<span class="fc" id="L80">        List&lt;PositionPlayer&gt; positionPlayers = this.positionPlayerRepository.findAll();</span>
<span class="fc" id="L81">        this.updateAndSaveStats(positionPlayers);</span>
<span class="fc" id="L82">        positionPlayers.sort((p1, p2) -&gt; p1.getName().compareToIgnoreCase(p2.getName()));</span>
<span class="fc" id="L83">        return this.paginationHandlerService.paginateAndMap(positionPlayers, page, size, this.positionPlayerMapper::toPositionPlayerDTO);</span>
    }

    @Transactional
    public Page&lt;PitcherDTO&gt; getAllPitchers(int page, int size) {
<span class="fc" id="L88">        List&lt;Pitcher&gt; pitchers = this.pitcherRepository.findAll();</span>
<span class="fc" id="L89">        this.updateAndSaveStats(pitchers);</span>
<span class="pc" id="L90">        pitchers.sort((p1, p2) -&gt; p1.getName().compareToIgnoreCase(p2.getName()));</span>
<span class="fc" id="L91">        return this.paginationHandlerService.paginateAndMap(pitchers, page, size, this.pitcherMapper::toPitcherDTO);</span>
    }

    /**
     * Updates and persists a player if their stats have changed.
     *
     * @param player the player to check and save
     * @throws IllegalArgumentException if the player subtype is not supported
     */
    private void saveIfStatsChanged(Player player) {
<span class="fc bfc" id="L101" title="All 2 branches covered.">        if (PlayerServiceOperations.updatePlayerStats(player)) {</span>
<span class="pc bpc" id="L102" title="1 of 3 branches missed.">            switch (player) {</span>
<span class="fc" id="L103">                case PositionPlayer pp -&gt; this.positionPlayerRepository.save(pp);</span>
<span class="fc" id="L104">                case Pitcher p -&gt; this.pitcherRepository.save(p);</span>
<span class="nc" id="L105">                default -&gt; throw new IllegalArgumentException(&quot;Unexpected subtype: &quot; + player.getClass().getName());</span>
            }
        }
<span class="fc" id="L108">    }</span>

    private &lt;T extends Player&gt; void updateAndSaveStats(List&lt;T&gt; players) {
<span class="fc" id="L111">        players.forEach(this::saveIfStatsChanged);</span>
<span class="fc" id="L112">    }</span>

    @Transactional
    public PlayerDTO findPlayerByName(String name) {
<span class="fc" id="L116">        Player player = this.playerRepository.findByNameOrThrow(name);</span>
<span class="fc" id="L117">        this.saveIfStatsChanged(player);</span>
<span class="fc bfc" id="L118" title="All 2 branches covered.">        return (player instanceof PositionPlayer pp)</span>
<span class="fc" id="L119">                ? positionPlayerMapper.toPositionPlayerDTO(pp)</span>
<span class="fc" id="L120">                : pitcherMapper.toPitcherDTO((Pitcher) player);</span>
    }

    public List&lt;PositionPlayer&gt; getUpdatedPositionPlayersOfTeam(Team team) {
<span class="fc" id="L124">        List&lt;PositionPlayer&gt; players = this.positionPlayerRepository.findByTeamOrderByNameAsc(team);</span>

<span class="fc" id="L126">        players.forEach(p -&gt; {</span>
<span class="fc" id="L127">            boolean hasChanged = PlayerServiceOperations.updatePlayerStats(p);</span>
<span class="pc bpc" id="L128" title="1 of 2 branches missed.">            if (hasChanged) {</span>
<span class="fc" id="L129">                this.positionPlayerRepository.save(p);</span>
            }
<span class="fc" id="L131">        });</span>
<span class="fc" id="L132">        return players;</span>
    }
    
    public List&lt;Pitcher&gt; getUpdatedPitchersOfTeam(Team team) {
<span class="fc" id="L136">        List&lt;Pitcher&gt; pitchers = this.pitcherRepository.findByTeamOrderByNameAsc(team);</span>

<span class="fc" id="L138">        pitchers.forEach(p -&gt; {</span>
<span class="fc" id="L139">            boolean hasChanged = PlayerServiceOperations.updatePlayerStats(p);</span>
<span class="pc bpc" id="L140" title="1 of 2 branches missed.">            if (hasChanged) {</span>
<span class="fc" id="L141">                this.pitcherRepository.save(p);</span>
            }
<span class="fc" id="L143">        });</span>
<span class="fc" id="L144">        return pitchers;</span>
    }

    @Transactional
    public Page&lt;PositionPlayerSummaryDTO&gt; getAllPositionPlayersOfATeam(String teamName, int page, int size) {
<span class="fc" id="L149">        Team team = this.teamRepository.findByNameOrThrow(teamName);</span>
<span class="fc" id="L150">        List&lt;PositionPlayer&gt; players = this.getUpdatedPositionPlayersOfTeam(team);</span>
<span class="fc" id="L151">        return this.paginationHandlerService.paginateAndMap(players, page, size, this.positionPlayerMapper::toPositionPlayerSummaryDTO);</span>
    }

    @Transactional
    public Page&lt;PitcherSummaryDTO&gt; getAllPitchersOfATeam(String teamName, int page, int size) {
<span class="fc" id="L156">        Team team = this.teamRepository.findByNameOrThrow(teamName);</span>
<span class="fc" id="L157">        List&lt;Pitcher&gt; players = this.getUpdatedPitchersOfTeam(team);</span>
<span class="fc" id="L158">        return this.paginationHandlerService.paginateAndMap(players, page, size, this.pitcherMapper::toPitcherSummaryDTO);</span>
    }

    /**
     * Helper method that checks whether the given team roster has available slots for new players.
     *
     * @param team the team whose roster size will be validated
     * @throws RosterFullException if the roster already contains 24 or more players
     */
    private void checkTeamAvailability(Team team) {
<span class="fc" id="L168">        int rosterSize = team.getPositionPlayers().size() + team.getPitchers().size();</span>
<span class="fc bfc" id="L169" title="All 2 branches covered.">        if (rosterSize &gt;= 24) {</span>
<span class="fc" id="L170">            throw new RosterFullException(team.getName() + &quot; roster is full&quot;);</span>
        }
<span class="fc" id="L172">    }</span>

    /**
     * Validates player creation by checking duplicates and team availability.
     *
     * @param playerName the name of the new player
     * @param teamName the team to assign
     * @return the validated team
     * @throws PlayerAlreadyExistsException if a player with the same name exists
     * @throws TeamNotFoundException if the team does not exist
     * @throws RosterFullException if the team roster is full
     */
    private Team playerCreationValidations(String playerName, String teamName) {
<span class="fc bfc" id="L185" title="All 2 branches covered.">        if (this.playerRepository.findByName(playerName).isPresent()) {</span>
<span class="fc" id="L186">            throw new PlayerAlreadyExistsException();</span>
        }
<span class="fc" id="L188">        Team team = this.teamRepository.findByNameOrThrow(teamName);</span>
<span class="fc" id="L189">        this.checkTeamAvailability(team);</span>
<span class="fc" id="L190">        return team;</span>
    }

    /**
     * @implNote Creating a player means that the player has been promoted to the MLB team.
     * At creation time, the team must not be null; however, once the player has played in the MLB,
     * the team may be null, which implies that the player has been sent down to the minors or designated for assignment (DFA).
     */
    @Transactional
    public PositionPlayerDTO createPositionPlayer(CreatePositionPlayerRequest request) {
<span class="fc" id="L200">        Team team = this.playerCreationValidations(request.name(), request.teamName());</span>
<span class="fc" id="L201">        PositionPlayer newPlayer = new PositionPlayer(request.name(), request.playerNumber(), team, request.position());</span>
<span class="fc" id="L202">        team.addPositionPlayer(newPlayer);</span>
<span class="fc" id="L203">        this.playerRepository.save(newPlayer);</span>
<span class="fc" id="L204">        return this.positionPlayerMapper.toPositionPlayerDTO(newPlayer);</span>
    }

    /**
     * @implNote Creating a player means that the player has been promoted to the MLB team.
     * At creation time, the team must not be null; however, once the player has played in the MLB,
     * the team may be null, which implies that the player has been sent down to the minors or designated for assignment (DFA).
     */
    @Transactional
    public PitcherDTO createPitcher(CreatePitcherRequest request) {
<span class="fc" id="L214">        Team team = this.playerCreationValidations(request.name(), request.teamName());</span>
<span class="fc" id="L215">        Pitcher newPlayer = new Pitcher(request.name(), request.playerNumber(), team, request.position());</span>
<span class="fc" id="L216">        team.addPitcher(newPlayer);</span>
<span class="fc" id="L217">        this.playerRepository.save(newPlayer);</span>
<span class="fc" id="L218">        return this.pitcherMapper.toPitcherDTO(newPlayer);</span>
    }

    @Transactional
    public PictureInfo updatePicture(String playerName, MultipartFile file) throws IOException {
<span class="fc" id="L223">        Player player = this.playerRepository.findByNameOrThrow(playerName);</span>
<span class="fc" id="L224">        PictureInfo pictureInfo = this.pictureService.uploadPicture(file);</span>
<span class="fc" id="L225">        player.setPicture(pictureInfo);</span>
<span class="fc" id="L226">        this.playerRepository.save(player);</span>
<span class="fc" id="L227">        return pictureInfo;</span>
    }

    /**
     * Helper method to update the team of a player.
     * @param player the player to update.
     * @param teamNameOpt the request field corresponding to the new possible team.
     */
    private void updateTeamIfNeeded(Player player, Optional&lt;String&gt; teamNameOpt) {
<span class="fc" id="L236">        teamNameOpt.ifPresent(newTeamName -&gt; {</span>
<span class="fc" id="L237">            Team newTeam = this.teamRepository.findByNameOrThrow(newTeamName);</span>
<span class="fc" id="L238">            this.checkTeamAvailability(newTeam);</span>
<span class="fc" id="L239">            Team oldTeam = player.getTeam();</span>
<span class="pc bpc" id="L240" title="1 of 2 branches missed.">            if (oldTeam != null) {</span>
<span class="pc bpc" id="L241" title="2 of 3 branches missed.">                switch (player) {</span>
<span class="fc" id="L242">                    case PositionPlayer pos -&gt; oldTeam.removePositionPlayer(pos);</span>
<span class="nc" id="L243">                    case Pitcher pit -&gt; oldTeam.removePitcher(pit);</span>
<span class="nc" id="L244">                    default -&gt; throw new IllegalArgumentException(&quot;Unsupported player subtype: &quot; + player.getClass().getName());</span>
                }
            }

<span class="fc" id="L248">            player.setTeam(newTeam);</span>
<span class="pc bpc" id="L249" title="2 of 3 branches missed.">            switch (player) {</span>
<span class="fc" id="L250">                case PositionPlayer pos -&gt; newTeam.addPositionPlayer(pos);</span>
<span class="nc" id="L251">                case Pitcher pit -&gt; newTeam.addPitcher(pit);</span>
<span class="nc" id="L252">                default -&gt; throw new IllegalArgumentException(&quot;Unsupported player subtype: &quot; + player.getClass().getName());</span>
            }
<span class="fc" id="L254">        });</span>
<span class="fc" id="L255">    }</span>

    @Transactional
    public void updatePositionPlayer(String playerName, EditPositionPlayerRequest request) {
<span class="fc" id="L259">        PositionPlayer player = this.positionPlayerRepository.findByNameOrThrow(playerName);</span>

<span class="fc" id="L261">        request.playerNumber().ifPresent(player::setPlayerNumber);</span>
<span class="fc" id="L262">        request.position().ifPresent(player::setPosition);</span>
<span class="fc" id="L263">        request.atBats().ifPresent(player::setAtBats);</span>
<span class="fc" id="L264">        request.walks().ifPresent(player::setWalks);</span>
<span class="fc" id="L265">        request.hits().ifPresent(player::setHits);</span>
<span class="fc" id="L266">        request.doubles().ifPresent(player::setDoubles);</span>
<span class="fc" id="L267">        request.triples().ifPresent(player::setTriples);</span>
<span class="fc" id="L268">        request.rbis().ifPresent(player::setRbis);</span>
<span class="fc" id="L269">        request.homeRuns().ifPresent(player::setHomeRuns);</span>
<span class="fc" id="L270">        this.updateTeamIfNeeded(player, request.teamName());</span>

<span class="fc" id="L272">        this.playerRepository.save(player);</span>
<span class="fc" id="L273">    }</span>

    @Transactional
    public void updatePitcher(String playerName, EditPitcherRequest request) {
<span class="fc" id="L277">        Pitcher player = this.pitcherRepository.findByNameOrThrow(playerName);</span>

<span class="fc" id="L279">        request.playerNumber().ifPresent(player::setPlayerNumber);</span>
<span class="fc" id="L280">        request.position().ifPresent(player::setPosition);</span>
<span class="fc" id="L281">        request.games().ifPresent(player::setGames);</span>
<span class="fc" id="L282">        request.wins().ifPresent(player::setWins);</span>
<span class="fc" id="L283">        request.losses().ifPresent(player::setLosses);</span>
<span class="fc" id="L284">        request.inningsPitched().ifPresent(player::setInningsPitched);</span>
<span class="fc" id="L285">        request.totalStrikeouts().ifPresent(player::setTotalStrikeouts);</span>
<span class="fc" id="L286">        request.walks().ifPresent(player::setWalks);</span>
<span class="fc" id="L287">        request.hitsAllowed().ifPresent(player::setHitsAllowed);</span>
<span class="fc" id="L288">        request.runsAllowed().ifPresent(player::setRunsAllowed);</span>
<span class="fc" id="L289">        request.saves().ifPresent(player::setSaves);</span>
<span class="fc" id="L290">        request.saveOpportunities().ifPresent(player::setSaveOpportunities);</span>
<span class="fc" id="L291">        this.updateTeamIfNeeded(player, request.teamName());</span>

<span class="fc" id="L293">        this.playerRepository.save(player);</span>
<span class="fc" id="L294">    }</span>

    /**
     * @implNote Deleting a player means that the player has retired from the MLB
     */
    @Transactional
    public PlayerDTO deletePlayer(String playerName) {
<span class="fc" id="L301">        Player player = this.playerRepository.findByNameOrThrow(playerName);</span>
<span class="fc" id="L302">        Team team = this.teamRepository.findByNameOrThrow(player.getTeam().getName());</span>

<span class="pc bpc" id="L304" title="1 of 3 branches missed.">        PlayerDTO result = switch (player) {</span>
<span class="fc" id="L305">            case PositionPlayer p -&gt; {</span>
<span class="fc" id="L306">                PositionPlayerDTO dto = this.positionPlayerMapper.toPositionPlayerDTO(p);</span>
<span class="fc" id="L307">                team.removePositionPlayer(p);</span>
<span class="fc" id="L308">                yield dto;</span>
            }
<span class="fc" id="L310">            case Pitcher p -&gt; {</span>
<span class="fc" id="L311">                PitcherDTO dto = this.pitcherMapper.toPitcherDTO(p);</span>
<span class="fc" id="L312">                team.removePitcher(p);</span>
<span class="fc" id="L313">                yield dto;</span>
            }
<span class="nc" id="L315">            default -&gt; throw new IllegalArgumentException(&quot;Unexpected subtype: &quot; + player.getClass().getName());</span>
        };
<span class="fc" id="L317">        this.playerRepository.delete(player);</span>
<span class="fc" id="L318">        return result;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>